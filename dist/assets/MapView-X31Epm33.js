const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CoxeyfD4.js","assets/index-Bm_xihTm.css"])))=>i.map(i=>d[i]);
import{c as ae,a as F,b as q,d as T,e as D,u as ie,f as ne,g as re,h as le,i as oe,r,_ as ce,j as e,C as z,k as de,M as ue,T as xe,m as pe,n as me,L as I,o as he,s as M,p as ge,q as fe}from"./index-CoxeyfD4.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["polygon",{points:"3 11 22 2 13 21 11 13 3 11",key:"1ltx0t"}]],ve=ae("navigation",be);function je(l,n,t){n.center!==t.center&&l.setLatLng(n.center),n.radius!=null&&n.radius!==t.radius&&l.setRadius(n.radius)}const we=F(function({center:n,children:t,...a},d){const m=new q.Circle(n,a);return T(m,D(d,{overlayContainer:m}))},je),L=F(function({positions:n,...t},a){const d=new q.Polyline(n,t);return T(d,D(a,{overlayContainer:d}))},function(n,t,a){t.positions!==a.positions&&n.setLatLngs(t.positions)}),O={lat:-.19788,lng:-78.502342},ye=[-.1985,-78.5035];function Ne({setHoverCoords:l,showPopup:n}){return fe({mousemove(t){l({lat:t.latlng.lat.toFixed(6),lng:t.latlng.lng.toFixed(6),x:t.containerPoint.x,y:t.containerPoint.y})},click(t){const a=`${t.latlng.lat.toFixed(6)}, ${t.latlng.lng.toFixed(6)}`;navigator.clipboard.writeText(a),n(`Copiado: ${a}`,"info")}}),null}function Ce({selectedSlot:l,userLocation:n,flyToZone:t}){const a=ge();return r.useEffect(()=>{if(a){if((t==null?void 0:t.center_latitude)!=null&&(t==null?void 0:t.center_longitude)!=null){a.flyTo([t.center_latitude,t.center_longitude],19,{duration:1.2});return}l?a.flyTo([l.latitude,l.longitude],22,{duration:1.5}):n&&a.flyTo([n.lat,n.lng],19)}},[l,n,t,a]),null}function Se({flyToZone:l}){const n=ie(),{user:t,profile:a,refetchProfile:d}=ne(),{data:m,isLoading:U}=re(),{mutate:K,isMutating:N}=le(),{data:b}=oe(t==null?void 0:t.id),v=!!b,Q=(b==null?void 0:b.id)??null,[j,B]=r.useState([]),[G,H]=r.useState(!1),[u,C]=r.useState(null),[k,S]=r.useState([]),[_,V]=r.useState([]),[h,Y]=r.useState(null),[W,E]=r.useState(!1),[P,J]=r.useState(null),[g,A]=r.useState(null),[f,X]=r.useState(null),[w,Z]=r.useState({duration:null,distance:null}),x=(s,i="success")=>{A({msg:s,type:i}),setTimeout(()=>A(null),4e3)},R=r.useCallback(async(s,i,o,p)=>{var c;try{const y=await(await fetch(`https://router.project-osrm.org/route/v1/foot/${i},${s};${p},${o}?overview=false`)).json();(c=y.routes)!=null&&c[0]&&Z({duration:Math.round(y.routes[0].duration/60),distance:(y.routes[0].distance/1e3).toFixed(1)})}catch($){console.error("Error ETA:",$)}},[]);r.useEffect(()=>{H(!0),ce(()=>import("./index-CoxeyfD4.js").then(i=>i.l),__vite__mapDeps([0,1])).then(i=>J(i));const s=navigator.geolocation.watchPosition(i=>Y({lat:i.coords.latitude,lng:i.coords.longitude}),i=>console.error("GPS Error:",i),{enableHighAccuracy:!0});return()=>navigator.geolocation.clearWatch(s)},[]),r.useEffect(()=>{m&&B(m)},[m]);const ee=r.useCallback((s,i)=>{!i||!s||(V([[O.lat,O.lng],[s.latitude,s.longitude]]),R(i.lat,i.lng,s.latitude,s.longitude),fetch(`https://router.project-osrm.org/route/v1/foot/${i.lng},${i.lat};${s.longitude},${s.latitude}?overview=full&geometries=geojson`).then(o=>o.json()).then(o=>{var p;(p=o.routes)!=null&&p[0]&&S(o.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]))}))},[R]),te=async()=>{const s=(a==null?void 0:a.role_id)==="r002"?5:3;if(((a==null?void 0:a.reservations_this_week)||0)>=s){x(`Límite alcanzado (${s}/semana)`,"error");return}if(v){x("Ya tienes una reserva activa.","error");return}try{await K({slotId:u.id,userId:t.id}),d==null||d(),x("Reserva realizada. Tienes 15 minutos para llegar.","success")}catch{x("Error al reservar","error")}},se=async s=>{E(!0);try{await M.from("parking_sessions").update({end_time:new Date().toISOString(),status:"completed"}).eq("user_id",t.id).eq("status","active"),await M.from("parking_slots").update({status:"available",user_id:null}).eq("id",s),n.invalidateQueries({queryKey:["activeSession",t.id]}),n.invalidateQueries({queryKey:["slots"]}),n.invalidateQueries({queryKey:["reservations",t.id]}),C(null),S([]),x("Sesión finalizada con éxito","info")}catch{x("Error al liberar","error")}finally{E(!1)}};return!G||U||!P?e.jsx("div",{className:"h-full w-full flex items-center justify-center font-black text-[#003366]",children:"CARGANDO..."}):e.jsxs("div",{className:"h-[calc(100vh-200px)] w-full relative",children:[f&&e.jsx("div",{className:"pointer-events-none absolute z-[5000] bg-[#003366] text-white px-3 py-1.5 rounded-xl text-[10px] font-mono border-2 border-white shadow-2xl",style:{left:f.x+15,top:f.y+15},children:e.jsxs("span",{className:"font-bold",children:[f.lat,", ",f.lng]})}),g&&e.jsx("div",{className:"absolute top-10 left-1/2 -translate-x-1/2 z-[2000] w-[90%] max-w-sm animate-in fade-in zoom-in",children:e.jsxs("div",{className:`flex items-center gap-4 p-5 rounded-[2rem] shadow-2xl border-4 border-white ${g.type==="success"?"bg-green-600":g.type==="error"?"bg-red-600":"bg-blue-600"} text-white`,children:[g.type==="info"?e.jsx(z,{size:24}):e.jsx(de,{size:30}),e.jsx("span",{className:"font-black uppercase italic text-sm",children:g.msg})]})}),e.jsxs(ue,{center:ye,zoom:19,maxZoom:24,className:"h-full w-full z-0",children:[e.jsx(xe,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",maxZoom:24,maxNativeZoom:19}),e.jsx(Ce,{selectedSlot:u,userLocation:h,flyToZone:l}),e.jsx(Ne,{setHoverCoords:X,showPopup:x}),h&&e.jsx(we,{center:[h.lat,h.lng],radius:3,pathOptions:{color:"white",fillColor:"#2563EB",fillOpacity:1,weight:3}}),j==null?void 0:j.map(s=>{const i=s.user_id===(t==null?void 0:t.id),o=(u==null?void 0:u.id)===s.id,p=s.status==="available"?"#22C55E":i?"#2563EB":"#EF4444",c=()=>{if(v&&s.id!==Q){x("Ya tienes una reserva activa. Finaliza tu sesión actual primero.","error");return}C(s),ee(s,h)};return e.jsx(pe,{position:[s.latitude,s.longitude],eventHandlers:{click:c},icon:P.divIcon({html:`<div style="background:${p}; width:30px; height:30px; border-radius:8px; border:3px solid white; display:flex; align-items:center; justify-content:center; color:white; font-weight:900; transition: 0.3s; transform: ${o?"scale(1.3)":"scale(1)"}">${o?"P":""}</div>`,className:""})},s.id)}),k.length>0&&e.jsx(L,{positions:k,pathOptions:{color:"#2563EB",weight:6,opacity:.5}}),_.length>0&&e.jsx(L,{positions:_,pathOptions:{color:"#CC0000",weight:3,dashArray:"8, 12",opacity:.7}})]}),u&&(()=>{const s=j.find(c=>c.id===u.id)||u,i=s.user_id===(t==null?void 0:t.id),o=(a==null?void 0:a.role_id)==="r002"?5:3,p=`${(a==null?void 0:a.reservations_this_week)??0} / ${o} semanales`;return e.jsxs("div",{className:"absolute bottom-6 left-1/2 -translate-x-1/2 z-[1000] w-[92%] max-w-md bg-white p-6 rounded-[2.5rem] shadow-2xl border-t-4 border-[#003366]",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsxs("div",{className:`w-16 h-16 rounded-2xl flex flex-col items-center justify-center text-white font-black ${s.status==="available"?"bg-[#003366]":"bg-[#CC0000]"}`,children:[e.jsx("span",{className:"text-[10px] opacity-70",children:"Nº"}),e.jsx("span",{className:"text-2xl",children:s.number})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[10px] font-black text-blue-500 uppercase tracking-widest",children:"Capacidad: 100%"}),e.jsx("h3",{className:"text-xl font-black text-[#003366] italic uppercase",children:"Espacio de Parqueo"})]})]}),w.duration!==null&&e.jsxs("div",{className:"flex items-center justify-between mb-5 px-5 py-4 bg-blue-50 rounded-2xl border-2 border-blue-100",children:[e.jsxs("div",{className:"flex items-center gap-3 text-[#003366]",children:[e.jsx(z,{size:22,className:"animate-pulse"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-[9px] font-bold uppercase opacity-60 leading-none",children:"Tiempo estimado"}),e.jsxs("span",{className:"text-2xl font-black italic",children:[w.duration," MIN"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-[9px] font-bold uppercase opacity-60 leading-none",children:"Distancia"}),e.jsxs("span",{className:"text-sm font-black text-gray-500",children:[w.distance," KM"]})]})]}),e.jsxs("div",{className:"mb-4 flex items-center gap-2 px-4 py-2 bg-amber-50 rounded-xl border border-amber-200",children:[e.jsx(me,{size:14,className:"text-amber-600"}),e.jsxs("p",{className:"text-[10px] font-bold text-amber-800 uppercase",children:["Reserva actual: ",p]})]}),e.jsx("div",{className:"flex flex-col gap-3",children:i?e.jsx("button",{onClick:()=>se(s.id),className:"w-full py-5 bg-[#CC0000] text-white rounded-2xl font-black uppercase tracking-widest shadow-lg flex items-center justify-center gap-3",children:W?e.jsx(I,{className:"animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(he,{size:20})," FINALIZAR SESIÓN"]})}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:te,disabled:s.status!=="available"||v||N,className:`w-full py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg transition-all flex items-center justify-center gap-2 ${s.status==="available"&&!v?"bg-[#003366] text-white active:scale-95":"bg-gray-200 text-gray-400 cursor-not-allowed"}`,children:N?e.jsx(I,{className:"animate-spin"}):s.status==="available"?e.jsxs(e.Fragment,{children:[e.jsx(ve,{size:20})," RESERVAR PUESTO"]}):"PUESTO OCUPADO"}),s.status==="available"&&e.jsx("p",{className:"text-[9px] text-center font-bold text-gray-400 uppercase italic",children:"* Tienes 15 minutos para ocupar el puesto tras la reserva."})]})})]})})()]})}export{Se as default};
